# åŸºæœ¬å—ç†è®º

## ğŸ”§ åŸºæœ¬å—å®šä¹‰

### **åŸºæœ¬å—ç‰¹å¾**
- **å•ä¸€å…¥å£ç‚¹**ï¼šåªæœ‰ä¸€ä¸ªå…¥å£
- **å•ä¸€å‡ºå£ç‚¹**ï¼šåªæœ‰ä¸€ä¸ªå‡ºå£  
- **çº¿æ€§æ‰§è¡Œ**ï¼šå—å†…è¯­å¥é¡ºåºæ‰§è¡Œï¼Œæ— è·³è½¬
- **åŸå­æ€§**ï¼šè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ

### **åŸºæœ¬å—è¾¹ç•Œè¯†åˆ«**
```
åŸºæœ¬å—å¼€å§‹æ¡ä»¶ï¼š
- ç¨‹åºå…¥å£ç‚¹
- è·³è½¬æŒ‡ä»¤çš„ç›®æ ‡ï¼ˆæ ‡ç­¾ï¼‰
- æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„ç›®æ ‡
- å‡½æ•°è°ƒç”¨åçš„è¿”å›ç‚¹

åŸºæœ¬å—ç»“æŸæ¡ä»¶ï¼š
- è·³è½¬æŒ‡ä»¤ï¼ˆjmpã€jneã€jeç­‰ï¼‰
- å‡½æ•°è¿”å›ï¼ˆretï¼‰
- ç¨‹åºç»“æŸ
```

## ğŸ“Š åŸºæœ¬å— vs å¤åˆè¯­å¥

### **åŸºæœ¬å—**
- åŸå­æ€§çš„è¯­å¥åºåˆ—
- çº¿æ€§æ‰§è¡Œï¼Œæ— æ§åˆ¶æµ
- å•ä¸€å…¥å£ï¼Œå•ä¸€å‡ºå£

### **å¤åˆè¯­å¥**
- åŒ…å«æ§åˆ¶æµç»“æ„ï¼ˆifã€whileã€forç­‰ï¼‰
- æœ‰å¤šä¸ªæ‰§è¡Œè·¯å¾„
- éœ€è¦è¿›ä¸€æ­¥åˆ†è§£

## ğŸ”„ æ§åˆ¶æµç»“æ„åˆ†è§£

### **Whileå¾ªç¯åˆ†è§£**
```c
while (x > 0) {
    x = x - 1;
}
```

**åˆ†è§£ç»“æœ**ï¼š
```
å—1: cmp x, 0; jle å—3  (æ¡ä»¶æ£€æŸ¥)
å—2: x = x - 1; jmp å—1  (å¾ªç¯ä½“)
å—3: å¾ªç¯å‡ºå£
```

### **Forå¾ªç¯åˆ†è§£**
```c
for (int i = 0; i < 10; i++) {
    sum = sum + i;
}
```

**åˆ†è§£ç»“æœ**ï¼š
```
å—1: mov i, 0         (åˆå§‹åŒ–)
å—2: cmp i, 10; jge å—5  (æ¡ä»¶æ£€æŸ¥)
å—3: add sum, i       (å¾ªç¯ä½“)
å—4: inc i; jmp å—2   (æ›´æ–°)
å—5: å¾ªç¯å‡ºå£
```

### **Ifè¯­å¥åˆ†è§£**
```c
if (x > 5) {
    x = x * 2;
} else {
    x = x + 1;
}
```

**åˆ†è§£ç»“æœ**ï¼š
```
å—1: cmp x, 5; jle å—3  (æ¡ä»¶æ£€æŸ¥)
å—2: x = x * 2; jmp å—4  (thenåˆ†æ”¯)
å—3: x = x + 1        (elseåˆ†æ”¯)
å—4: åˆå¹¶ç‚¹
```

## ğŸ¯ å—ä¸­å—å¤„ç†

### **å¯ä»¥ç”ŸæˆåŸºæœ¬å—**
- åªæœ‰èµ‹å€¼è¯­å¥
- åªæœ‰è¡¨è¾¾å¼è¯­å¥
- åªæœ‰å˜é‡å£°æ˜
- åªæœ‰å‡½æ•°è°ƒç”¨
- **æ²¡æœ‰æ§åˆ¶æµç»“æ„**

### **ä¸èƒ½ç”ŸæˆåŸºæœ¬å—**
- åŒ…å«`if`ã€`while`ã€`for`ç­‰æ§åˆ¶æµç»“æ„
- åŒ…å«`break`ã€`continue`ã€`return`ç­‰è·³è½¬è¯­å¥

### **å®é™…ä¾‹å­**
```c
void func() {
    int x = 10;        // åŸºæœ¬å—1å¼€å§‹ï¼šç¨‹åºå…¥å£
    {                  // åŸºæœ¬å—1ç»§ç»­ï¼šæ²¡æœ‰è·³è½¬
        int y = 6;     // åŸºæœ¬å—1ç»§ç»­ï¼šæ²¡æœ‰è·³è½¬
        x = 5;         // åŸºæœ¬å—1ç»§ç»­ï¼šæ²¡æœ‰è·³è½¬
    }                  // åŸºæœ¬å—1ç»“æŸï¼šæ²¡æœ‰è·³è½¬
    return x;          // åŸºæœ¬å—2å¼€å§‹ï¼šreturnè¯­å¥
}
```

**åˆ†è§£ç»“æœ**ï¼š
```
å—1: int x = 10; int y = 6; x = 5  (ä¸€ä¸ªåŸºæœ¬å—)
å—2: return x
```

## ğŸ”§ åŸºæœ¬å—æ•°æ®ç»“æ„

### **åŸºæœ¬å—è¡¨ç¤º**
```typescript
interface BasicBlock {
  id: string;                    // å—æ ‡è¯†ç¬¦
  statements: Statement[];       // ASTèŠ‚ç‚¹æ•°ç»„
  predecessors: BasicBlock[];    // å‰é©±å—
  successors: BasicBlock[];      // åç»§å—
  isEntry?: boolean;            // æ˜¯å¦ä¸ºå…¥å£å—
  isExit?: boolean;             // æ˜¯å¦ä¸ºå‡ºå£å—
}
```

### **å…³é”®ç‚¹**
- `statements`å­—æ®µå­˜å‚¨çš„æ˜¯**ASTèŠ‚ç‚¹**
- ä¸æ˜¯å­—ç¬¦ä¸²å½¢å¼çš„ä»£ç 
- ä¸æ˜¯æ±‡ç¼–æŒ‡ä»¤

## ğŸ“Š åŸºæœ¬å—å†…å®¹ç¤ºä¾‹

```c
void func() {
    int x = 10;
    if (x > 5) {
        x = x * 2;
    }
    return x;
}
```

### **å—1çš„ASTå†…å®¹**
```typescript
statements: [
  { type: 'VariableDeclaration', name: 'x', initializer: { type: 'NumberLiteral', value: 10 } }
]
```

### **å—2çš„ASTå†…å®¹**
```typescript
statements: [
  { type: 'BinaryExpression', operator: '>', left: { type: 'Identifier', name: 'x' }, right: { type: 'NumberLiteral', value: 5 } }
]
```

### **å—3çš„ASTå†…å®¹**
```typescript
statements: [
  { type: 'AssignmentStatement', name: 'x', value: { type: 'BinaryExpression', operator: '*', left: { type: 'Identifier', name: 'x' }, right: { type: 'NumberLiteral', value: 2 } } }
]
```

## ğŸ”§ åŠ¨æ€æ ˆç®¡ç†

### **åŸºæœ¬å—çº§åˆ«çš„æ ˆç®¡ç†**
- æ¯ä¸ªåŸºæœ¬å—åˆ†æå…¶å˜é‡å£°æ˜
- åŠ¨æ€è°ƒæ•´æ ˆæŒ‡é’ˆ
- åŸºäºASTè¿›è¡Œæ ˆç©ºé—´åˆ†é…

### **æ ˆç®¡ç†å®ç°**
```typescript
function generateStackManagement(block: BasicBlock) {
  let stackOffset = 0;
  
  // åˆ†æå—ä¸­å˜é‡å£°æ˜
  for (const stmt of block.statements) {
    if (stmt.type === 'VariableDeclaration') {
      stackOffset++;
    }
  }
  
  // ç”Ÿæˆæ ˆç®¡ç†ä»£ç 
  if (stackOffset > 0) {
    generate(`sub esp, ${stackOffset}`);
  }
}
```

### **å®é™…ä¾‹å­**
```c
void func() {
    int x = 10;        // åŸºæœ¬å—1ï¼šsub esp, 1 (ä¸ºxåˆ†é…ç©ºé—´)
    {                  // è¿›å…¥å—ä¸­å—
        int y = 6;     // åŸºæœ¬å—1ï¼šsub esp, 1 (ä¸ºyåˆ†é…ç©ºé—´)
        x = 5;         // åŸºæœ¬å—1ï¼šä½¿ç”¨å·²åˆ†é…çš„ç©ºé—´
    }                  // é€€å‡ºå—ä¸­å—ï¼šadd esp, 1 (é‡Šæ”¾yçš„ç©ºé—´)
    return x;          // åŸºæœ¬å—2ï¼šä½¿ç”¨xçš„ç©ºé—´
}
```

## ğŸ¯ CFGç”Ÿæˆç®—æ³•

### **æ ¸å¿ƒæ­¥éª¤**
```
1. æ‰«ææ‰€æœ‰è¯­å¥ï¼Œè¯†åˆ«åŸºæœ¬å—è¾¹ç•Œ
2. ä¸ºæ¯ä¸ªåŸºæœ¬å—åˆ†é…å”¯ä¸€ID
3. åˆ†ææ§åˆ¶æµï¼Œå»ºç«‹å—ä¹‹é—´çš„è¿æ¥å…³ç³»
4. è¯†åˆ«å…¥å£å—å’Œå‡ºå£å—
5. æ„å»ºè¾¹é›†åˆï¼Œè¡¨ç¤ºæ§åˆ¶æµè½¬ç§»
```

### **æ§åˆ¶æµåˆ†æ**
- **æ— æ¡ä»¶è·³è½¬**ï¼š`jmp label` â†’ ç›´æ¥è¿æ¥
- **æ¡ä»¶è·³è½¬**ï¼š`jne label` â†’ ä¸¤ä¸ªåˆ†æ”¯ï¼ˆtrue/falseï¼‰
- **å‡½æ•°è°ƒç”¨**ï¼š`call func` â†’ å‡½æ•°å…¥å£
- **å‡½æ•°è¿”å›**ï¼š`ret` â†’ è°ƒç”¨ç‚¹

## ğŸ”§ æ— æ¡ä»¶è·³è½¬è¯¦è§£

### **æ— æ¡ä»¶è·³è½¬ vs æ¡ä»¶è·³è½¬**
- **æ— æ¡ä»¶è·³è½¬**ï¼š`jmp label` - æ€»æ˜¯è·³è½¬ï¼Œæ²¡æœ‰æ¡ä»¶åˆ¤æ–­
- **æ¡ä»¶è·³è½¬**ï¼š`jne label`ã€`je label`ã€`jle label`ç­‰ - æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦è·³è½¬

### **ç”ŸæˆjmpæŒ‡ä»¤çš„æƒ…å†µ**
1. **`goto`è¯­å¥** - æœ€ç›´æ¥çš„æ— æ¡ä»¶è·³è½¬
2. **å¾ªç¯æ§åˆ¶** - `continue`ã€`break`ç­‰
3. **å‡½æ•°è°ƒç”¨** - åŒ…æ‹¬é€’å½’è°ƒç”¨
4. **å¼‚å¸¸å¤„ç†** - `try-catch`ç­‰
5. **å°¾é€’å½’ä¼˜åŒ–** - é€’å½’ä¼˜åŒ–ä¸ºå¾ªç¯

### **å®é™…ä¾‹å­**
```c
void func() {
    int x = 10;
    while (x > 0) {       // æ¡ä»¶è·³è½¬ï¼šcmp x, 0; jle exit
        x = x - 1;       // æ— æ¡ä»¶è·³è½¬ï¼šjmp while_start
    }
    goto label1;         // æ— æ¡ä»¶è·³è½¬ï¼šjmp label1
    x = 20;
label1:
    return x;
}
```

### **æ±‡ç¼–ä»£ç **
```asm
while_start:
    cmp x, 0              ; æ¡ä»¶æ£€æŸ¥
    jle exit              ; æ¡ä»¶è·³è½¬ï¼šå¦‚æœ x <= 0ï¼Œè·³è½¬åˆ°exit
    sub x, 1              ; å¾ªç¯ä½“
    jmp while_start       ; æ— æ¡ä»¶è·³è½¬ï¼šæ€»æ˜¯è·³å›å¾ªç¯å¼€å§‹
    jmp label1            ; æ— æ¡ä»¶è·³è½¬ï¼ˆgotoï¼‰
label1:
    ret
```

### **å…³é”®ç†è§£**
1. **æ— æ¡ä»¶è·³è½¬** = æ±‡ç¼–æŒ‡ä»¤ `jmp`
2. **è·³è½¬ç›®æ ‡** = é«˜çº§è¯­è¨€ç»“æ„ï¼ˆwhileã€forã€continueã€breakç­‰ï¼‰
3. **é€’å½’ = å‡½æ•°è°ƒç”¨**ï¼Œä¸æ˜¯ç‹¬ç«‹çš„jmpç±»å‹
4. **é«˜çº§è¯­è¨€ç»“æ„**è¢«åˆ†è§£æˆæ±‡ç¼–æŒ‡ä»¤ï¼ŒåŒ…æ‹¬æ— æ¡ä»¶è·³è½¬

## ğŸ’¡ å…³é”®ç†è§£

1. **åŸºæœ¬å—æ˜¯çº¿æ€§æ‰§è¡Œåˆ°è·³è½¬ç‚¹çš„è¯­å¥åºåˆ—**
2. **å¤åˆè¯­å¥è¢«åˆ†è§£**æˆå¤šä¸ªåŸºæœ¬å—
3. **åŸºæœ¬å—å­˜å‚¨ASTèŠ‚ç‚¹**ï¼Œä¸æ˜¯ä»£ç å­—ç¬¦ä¸²
4. **æ ˆç®¡ç†åŸºäºåŸºæœ¬å—çš„ASTåˆ†æ**
5. **CFGä¸­åªæœ‰åŸºæœ¬å—**ï¼Œæ²¡æœ‰å¤åˆè¯­å¥

## ğŸ”— æ€»ç»“

åŸºæœ¬å—æ˜¯CFGçš„æ ¸å¿ƒï¼Œå®ƒï¼š
- å°†å¤æ‚çš„æ§åˆ¶æµç»“æ„åˆ†è§£ä¸ºç®€å•çš„çº¿æ€§åºåˆ—
- åŸºäºASTè¿›è¡Œè¡¨ç¤ºå’Œåˆ†æ
- æ”¯æŒåŠ¨æ€æ ˆç®¡ç†
- ä¸ºç¼–è¯‘å™¨ä¼˜åŒ–æä¾›åŸºç¡€
